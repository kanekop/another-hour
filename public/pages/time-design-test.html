
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Design Modes Test - Another Hour</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/css/components.css">
  <style>
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .mode-selector {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    
    .mode-selector select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
    }
    
    .time-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .time-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .time-card h3 {
      margin-top: 0;
      color: #333;
    }
    
    .large-time {
      font-size: 2em;
      font-weight: bold;
      color: #2196F3;
      margin: 10px 0;
    }
    
    .status-indicator {
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.9em;
      margin: 5px 0;
    }
    
    .status-designed {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .status-another {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .debug-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 0.9em;
    }
    
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    
    .success {
      color: #388e3c;
      background: #e8f5e8;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    
    .migration-panel {
      background: #fff8e1;
      border: 1px solid #ffcc02;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover {
      background: #1976D2;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>Time Design Modes Test</h1>
    
    <div id="migrationPanel" class="migration-panel" style="display: none;">
      <h3>🔄 Legacy Data Migration</h3>
      <p>Legacy Another Hour settings detected. Click below to migrate to the new Time Design system.</p>
      <button id="migrateBtn">Migrate Now</button>
      <button id="validateBtn">Validate Migration</button>
      <div id="migrationStatus"></div>
    </div>
    
    <div class="mode-selector">
      <h3>Select Time Design Mode</h3>
      <select id="modeSelect">
        <option value="">Loading modes...</option>
      </select>
      <div id="modeDescription"></div>
      <button id="switchModeBtn" disabled>Switch Mode</button>
    </div>
    
    <div class="time-display">
      <div class="time-card">
        <h3>Current Time Design</h3>
        <div id="designTime" class="large-time">--:--:--</div>
        <div id="designStatus" class="status-indicator">Initializing...</div>
        <div id="designPeriod">--</div>
      </div>
      
      <div class="time-card">
        <h3>Legacy Comparison</h3>
        <div id="legacyTime" class="large-time">--:--:--</div>
        <div id="legacyStatus" class="status-indicator">--</div>
        <div id="legacyPeriod">--</div>
      </div>
      
      <div class="time-card">
        <h3>Real Time</h3>
        <div id="realTime" class="large-time">--:--:--</div>
        <div class="status-indicator">UTC / Local Time</div>
      </div>
    </div>
    
    <div class="debug-info">
      <h4>Debug Information</h4>
      <div id="debugInfo">Initializing...</div>
    </div>
    
    <div id="errorLog"></div>
  </div>

  <!-- Load Time Design scripts -->
  <script type="module">
    import { timeDesignManager } from '/js/time-design/modes/TimeDesignManager.js';
    import { getCustomAhAngles } from '/clock-core.js';
    import { autoMigrate, needsMigration, migrateLegacyData, validateMigration } from '/js/time-design-migration.js';

    // DOM elements
    const elements = {
      migrationPanel: document.getElementById('migrationPanel'),
      migrateBtn: document.getElementById('migrateBtn'),
      validateBtn: document.getElementById('validateBtn'),
      migrationStatus: document.getElementById('migrationStatus'),
      modeSelect: document.getElementById('modeSelect'),
      modeDescription: document.getElementById('modeDescription'),
      switchModeBtn: document.getElementById('switchModeBtn'),
      designTime: document.getElementById('designTime'),
      designStatus: document.getElementById('designStatus'),
      designPeriod: document.getElementById('designPeriod'),
      legacyTime: document.getElementById('legacyTime'),
      legacyStatus: document.getElementById('legacyStatus'),
      legacyPeriod: document.getElementById('legacyPeriod'),
      realTime: document.getElementById('realTime'),
      debugInfo: document.getElementById('debugInfo'),
      errorLog: document.getElementById('errorLog')
    };

    // State
    let updateInterval = null;
    let timeDesignReady = false;

    // Initialize
    async function initialize() {
      try {
        // Check for migration needs
        if (needsMigration()) {
          elements.migrationPanel.style.display = 'block';
          showStatus('Migration needed - legacy data detected', 'warning');
        } else {
          // Auto-migrate if needed
          const migrationResult = await autoMigrate();
          if (migrationResult.migrated) {
            showStatus('Auto-migration completed', 'success');
          }
        }

        // Initialize Time Design Manager
        await timeDesignManager.initialize();
        timeDesignReady = true;

        // Load available modes
        loadModes();

        // Start time updates
        startTimeUpdates();

        showStatus('Time Design system initialized', 'success');

      } catch (error) {
        console.error('Initialization failed:', error);
        showStatus(`Initialization failed: ${error.message}`, 'error');
      }
    }

    // Load available modes into selector
    function loadModes() {
      const modes = timeDesignManager.getAvailableModes();
      const currentMode = timeDesignManager.getCurrentMode();

      elements.modeSelect.innerHTML = '';
      
      modes.forEach(mode => {
        const option = document.createElement('option');
        option.value = mode.id;
        option.textContent = mode.name;
        if (currentMode && mode.id === currentMode.id) {
          option.selected = true;
        }
        elements.modeSelect.appendChild(option);
      });

      elements.switchModeBtn.disabled = false;
      updateModeDescription();
    }

    // Update mode description
    function updateModeDescription() {
      const selectedId = elements.modeSelect.value;
      const modes = timeDesignManager.getAvailableModes();
      const mode = modes.find(m => m.id === selectedId);
      
      if (mode) {
        elements.modeDescription.textContent = mode.description;
      }
    }

    // Start time updates
    function startTimeUpdates() {
      if (updateInterval) clearInterval(updateInterval);
      
      updateInterval = setInterval(() => {
        updateTimes();
      }, 1000);

      updateTimes(); // Initial update
    }

    // Update all time displays
    function updateTimes() {
      const now = new Date();
      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

      try {
        // Real time
        elements.realTime.textContent = now.toLocaleTimeString();

        // Time Design calculation
        if (timeDesignReady) {
          const designResult = timeDesignManager.calculate(now, timezone);
          
          elements.designTime.textContent = designResult.displayString;
          elements.designStatus.textContent = designResult.periodName;
          elements.designStatus.className = `status-indicator ${designResult.isAnotherHour ? 'status-another' : 'status-designed'}`;
          elements.designPeriod.textContent = `Scale: ${designResult.scaleFactor.toFixed(2)}x`;

          // Update debug info
          updateDebugInfo(designResult);
        }

        // Legacy comparison
        const legacyDuration = parseInt(localStorage.getItem('personalizedAhDurationMinutes') || '1380', 10);
        const legacyResult = getCustomAhAngles(now, timezone, legacyDuration);
        
        elements.legacyTime.textContent = `${String(legacyResult.aphHours).padStart(2, '0')}:${String(legacyResult.aphMinutes).padStart(2, '0')}:${String(Math.floor(legacyResult.aphSeconds)).padStart(2, '0')}`;
        elements.legacyStatus.textContent = legacyResult.isPersonalizedAhPeriod ? 'Another Hour' : 'Designed 24';
        elements.legacyStatus.className = `status-indicator ${legacyResult.isPersonalizedAhPeriod ? 'status-another' : 'status-designed'}`;
        elements.legacyPeriod.textContent = `Legacy (${legacyDuration}min)`;

      } catch (error) {
        console.error('Time update failed:', error);
        showStatus(`Time update failed: ${error.message}`, 'error');
      }
    }

    // Update debug information
    function updateDebugInfo(result) {
      const currentMode = timeDesignManager.getCurrentMode();
      
      const debugData = {
        mode: currentMode?.id || 'unknown',
        timestamp: new Date().toISOString(),
        calculation: {
          hours: result.hours,
          minutes: result.minutes,
          seconds: result.seconds,
          scaleFactor: result.scaleFactor,
          isAnotherHour: result.isAnotherHour
        },
        segment: result.segmentInfo
      };

      elements.debugInfo.textContent = JSON.stringify(debugData, null, 2);
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const div = document.createElement('div');
      div.className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      
      elements.errorLog.appendChild(div);
      elements.errorLog.scrollTop = elements.errorLog.scrollHeight;

      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Event listeners
    elements.modeSelect.addEventListener('change', updateModeDescription);

    elements.switchModeBtn.addEventListener('click', async () => {
      const selectedId = elements.modeSelect.value;
      if (!selectedId) return;

      try {
        elements.switchModeBtn.disabled = true;
        const result = await timeDesignManager.setMode(selectedId);
        
        if (result.success) {
          showStatus(`Switched to ${selectedId} mode`, 'success');
          updateModeDescription();
        } else {
          showStatus(`Failed to switch mode: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`Mode switch error: ${error.message}`, 'error');
      } finally {
        elements.switchModeBtn.disabled = false;
      }
    });

    elements.migrateBtn.addEventListener('click', async () => {
      try {
        elements.migrateBtn.disabled = true;
        elements.migrationStatus.textContent = 'Migrating...';
        
        const result = await migrateLegacyData();
        
        if (result.success) {
          elements.migrationStatus.innerHTML = '<div class="success">✅ Migration completed!</div>';
          elements.migrationPanel.style.display = 'none';
          
          // Reload modes
          loadModes();
          showStatus('Migration completed successfully', 'success');
        } else {
          elements.migrationStatus.innerHTML = `<div class="error">❌ Migration failed: ${result.error}</div>`;
        }
      } catch (error) {
        elements.migrationStatus.innerHTML = `<div class="error">❌ Migration error: ${error.message}</div>`;
      } finally {
        elements.migrateBtn.disabled = false;
      }
    });

    elements.validateBtn.addEventListener('click', async () => {
      try {
        const result = await validateMigration();
        
        if (result.valid) {
          elements.migrationStatus.innerHTML = '<div class="success">✅ Migration is valid</div>';
        } else {
          elements.migrationStatus.innerHTML = `<div class="error">❌ Validation failed: ${result.reason || result.error}</div>`;
        }
      } catch (error) {
        elements.migrationStatus.innerHTML = `<div class="error">❌ Validation error: ${error.message}</div>`;
      }
    });

    // Start initialization
    initialize();
  </script>
</body>
</html>
