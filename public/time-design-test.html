<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Design Modes Test - Another Hour</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/css/components.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .mode-selector {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .mode-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .mode-card:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .mode-card.active {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .config-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .clock-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .clock-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .analog-clock {
            width: 200px;
            height: 200px;
            margin: 0 auto 15px;
            border: 2px solid #333;
            border-radius: 50%;
            position: relative;
        }
        .clock-hand {
            position: absolute;
            background: #333;
            transform-origin: bottom center;
            left: 50%;
            border-radius: 2px;
        }
        .hour-hand {
            width: 4px;
            height: 60px;
            bottom: 50%;
            margin-left: -2px;
        }
        .minute-hand {
            width: 2px;
            height: 80px;
            bottom: 50%;
            margin-left: -1px;
        }
        .second-hand {
            width: 1px;
            height: 90px;
            bottom: 50%;
            margin-left: -0.5px;
            background: red;
        }
        .center-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #333;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .config-input {
            margin: 10px 0;
        }
        .config-input label {
            display: block;
            margin-bottom: 5px;
        }
        .config-input input, .config-input select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        /* Clock tick marks */
        .clock-ticks {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        .tick {
            position: absolute;
            background: #666;
            transform-origin: bottom center;
        }
        .tick.major {
            width: 2px;
            height: 15px;
            background: #333;
        }
        .tick.minor {
            width: 1px;
            height: 8px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Time Design Modes Test</h1>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <h2>Select Time Design Mode</h2>
            <div id="mode-grid" class="mode-grid">
                <!-- Modes will be populated by JavaScript -->
            </div>
        </div>

        <!-- Configuration Panel -->
        <div id="config-panel" class="config-panel">
            <h2>Configuration</h2>
            <div id="config-inputs">
                <!-- Config inputs will be populated based on selected mode -->
            </div>
        </div>

        <!-- Clock Display -->
        <div class="clock-display">
            <div class="clock-container">
                <h3>Standard Time</h3>
                <div class="analog-clock" id="standard-clock">
                    <div class="clock-ticks" id="standard-ticks"></div>
                    <div class="clock-hand hour-hand" id="standard-hour"></div>
                    <div class="clock-hand minute-hand" id="standard-minute"></div>
                    <div class="clock-hand second-hand" id="standard-second"></div>
                    <div class="center-dot"></div>
                </div>
                <div id="standard-time">--:--:--</div>
            </div>

            <div class="clock-container">
                <h3>Another Hour Time</h3>
                <div class="analog-clock" id="ah-clock">
                    <div class="clock-ticks" id="ah-ticks"></div>
                    <div class="clock-hand hour-hand" id="ah-hour"></div>
                    <div class="clock-hand minute-hand" id="ah-minute"></div>
                    <div class="clock-hand second-hand" id="ah-second"></div>
                    <div class="center-dot"></div>
                </div>
                <div id="ah-time">--:--:--</div>
            </div>
        </div>

        <!-- Status Display -->
        <div id="status-display" class="status-display">
            <h3>Current Mode Status</h3>
            <div id="mode-info">No mode selected</div>
            <div id="error-messages"></div>
        </div>
    </div>

    <script type="module">
        import { TimeDesignManager } from '/js/time-design/TimeDesignManager.js';

        class TimeDesignTest {
            constructor() {
                this.manager = new TimeDesignManager();
                this.currentMode = null;
                this.updateInterval = null;

                this.initializeUI();
                this.setupEventListeners();
                this.startClock();
            }

            initializeUI() {
                this.renderModeSelector();
                this.setupClockTicks();
            }

            renderModeSelector() {
                const modeGrid = document.getElementById('mode-grid');
                const availableModes = this.manager.getAvailableModes();

                modeGrid.innerHTML = '';
                availableModes.forEach(mode => {
                    const modeCard = document.createElement('div');
                    modeCard.className = 'mode-card';
                    modeCard.dataset.mode = mode.name;

                    modeCard.innerHTML = `
                        <h4>${mode.displayName}</h4>
                        <p>${mode.description}</p>
                    `;

                    modeCard.addEventListener('click', () => {
                        this.selectMode(mode.name);
                    });

                    modeGrid.appendChild(modeCard);
                });
            }

            selectMode(modeName) {
                // Update UI
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('active');
                });
                document.querySelector(`[data-mode="${modeName}"]`).classList.add('active');

                // Set mode in manager
                if (this.manager.setMode(modeName)) {
                    this.currentMode = modeName;
                    this.renderConfigPanel();
                    this.updateStatus();
                } else {
                    this.showError(`Failed to set mode: ${modeName}`);
                }
            }

            renderConfigPanel() {
                const configInputs = document.getElementById('config-inputs');
                const modeInfo = this.manager.getCurrentModeInfo();

                if (!modeInfo) {
                    configInputs.innerHTML = '<p>No mode selected</p>';
                    return;
                }

                const schema = this.manager.getAvailableModes().find(m => m.name === modeInfo.name)?.configSchema || {};
                const currentConfig = this.manager.getConfig();

                configInputs.innerHTML = '';

                Object.entries(schema).forEach(([key, fieldConfig]) => {
                    const div = document.createElement('div');
                    div.className = 'config-input';

                    const label = document.createElement('label');
                    label.textContent = fieldConfig.label || key;

                    let input;
                    if (fieldConfig.type === 'select') {
                        input = document.createElement('select');
                        fieldConfig.options.forEach(option => {
                            const optionEl = document.createElement('option');
                            optionEl.value = option.value;
                            optionEl.textContent = option.label;
                            input.appendChild(optionEl);
                        });
                    } else {
                        input = document.createElement('input');
                        input.type = fieldConfig.type === 'time' ? 'time' : (fieldConfig.type || 'text');
                        if (fieldConfig.min !== undefined) input.min = fieldConfig.min;
                        if (fieldConfig.max !== undefined) input.max = fieldConfig.max;
                        if (fieldConfig.step !== undefined) input.step = fieldConfig.step;
                    }

                    input.value = currentConfig[key] !== undefined ? currentConfig[key] : (fieldConfig.default || '');
                    input.addEventListener('change', () => {
                        this.updateConfig(key, input.value);
                    });

                    div.appendChild(label);
                    div.appendChild(input);
                    configInputs.appendChild(div);
                });

                if (Object.keys(schema).length === 0) {
                    configInputs.innerHTML = '<p>No configuration options for this mode</p>';
                }
            }

            updateConfig(key, value) {
                const schema = this.manager.getAvailableModes().find(m => m.name === this.currentMode)?.configSchema || {};
                const fieldConfig = schema[key];

                // Type conversion
                if (fieldConfig) {
                    if (fieldConfig.type === 'number') {
                        value = parseFloat(value);
                    } else if (fieldConfig.type === 'checkbox') {
                        value = value === 'true' || value === true;
                    }
                }

                this.manager.updateConfig({ [key]: value });
                this.updateStatus();
            }

            setupClockTicks() {
                ['standard-ticks', 'ah-ticks'].forEach(ticksId => {
                    const ticks = document.getElementById(ticksId);
                    ticks.innerHTML = '';

                    for (let i = 0; i < 60; i++) {
                        const tick = document.createElement('div');
                        tick.className = `tick ${i % 5 === 0 ? 'major' : 'minor'}`;
                        tick.style.transform = `rotate(${i * 6}deg)`;
                        tick.style.top = '10px';
                        tick.style.left = '50%';
                        tick.style.marginLeft = '-1px';
                        ticks.appendChild(tick);
                    }
                });
            }

            setupEventListeners() {
                this.manager.addListener((modeInfo) => {
                    this.updateStatus();
                });
            }

            startClock() {
                this.updateInterval = setInterval(() => {
                    this.updateClocks();
                }, 100);
            }

            updateClocks() {
                const now = new Date();

                // Update standard clock
                this.updateStandardClock(now);

                // Update AH clock if mode is active
                if (this.currentMode) {
                    this.updateAHClock(now);
                }
            }

            updateStandardClock(date) {
                const hours = date.getHours() % 12;
                const minutes = date.getMinutes();
                const seconds = date.getSeconds();

                const hourAngle = (hours * 30) + (minutes * 0.5);
                const minuteAngle = minutes * 6;
                const secondAngle = seconds * 6;

                document.getElementById('standard-hour').style.transform = `rotate(${hourAngle}deg)`;
                document.getElementById('standard-minute').style.transform = `rotate(${minuteAngle}deg)`;
                document.getElementById('standard-second').style.transform = `rotate(${secondAngle}deg)`;

                document.getElementById('standard-time').textContent = date.toLocaleTimeString();
            }

            updateAHClock(date) {
                try {
                    const angles = this.manager.getTimeAngles(date, 'UTC');

                    if (angles) {
                        document.getElementById('ah-hour').style.transform = `rotate(${angles.hourAngle || 0}deg)`;
                        document.getElementById('ah-minute').style.transform = `rotate(${angles.minuteAngle || 0}deg)`;
                        document.getElementById('ah-second').style.transform = `rotate(${angles.secondAngle || 0}deg)`;

                        // Format AH time
                        const ahTime = `${String(angles.aphHours || 0).padStart(2, '0')}:${String(angles.aphMinutes || 0).padStart(2, '0')}:${String(Math.floor(angles.aphSeconds || 0)).padStart(2, '0')}`;
                        document.getElementById('ah-time').textContent = ahTime;

                        this.clearError();
                    }
                } catch (error) {
                    this.showError(`Clock update error: ${error.message}`);
                }
            }

            updateStatus() {
                const modeInfo = this.manager.getCurrentModeInfo();
                const modeInfoDiv = document.getElementById('mode-info');

                if (modeInfo) {
                    modeInfoDiv.innerHTML = `
                        <strong>Active Mode:</strong> ${modeInfo.displayName}<br>
                        <strong>Description:</strong> ${modeInfo.description}<br>
                        <strong>Configuration:</strong> ${JSON.stringify(modeInfo.config, null, 2)}
                    `;
                } else {
                    modeInfoDiv.textContent = 'No mode selected';
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('error-messages');
                errorDiv.innerHTML = `<div class="error">${message}</div>`;
                console.error('TimeDesignTest:', message);
            }

            clearError() {
                const errorDiv = document.getElementById('error-messages');
                errorDiv.innerHTML = '';
            }
        }

        // Initialize the test page
        window.addEventListener('DOMContentLoaded', () => {
            try {
                new TimeDesignTest();
            } catch (error) {
                console.error('Failed to initialize Time Design Test:', error);
                document.getElementById('error-messages').innerHTML = 
                    `<div class="error">Failed to initialize: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>