<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Design Modes - Comprehensive Test Page</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            font-size: 14px;
            overflow-x: hidden;
        }

        /* Container with max height to fit in viewport */
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 8px;
        }

        /* Compact header */
        .header {
            background: white;
            border-radius: 6px;
            padding: 8px 16px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.3em;
            color: #2c3e50;
            margin: 0;
        }

        /* Main layout - more compact grid */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 200px 1fr 280px;
            gap: 8px;
            min-height: 0; /* Important for Firefox */
        }

        /* Panel base styles */
        .panel {
            background: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel h2 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #34495e;
            border-bottom: 1px solid #3498db;
            padding-bottom: 5px;
            flex-shrink: 0;
        }

        /* Left Panel - Mode List */
        .mode-list {
            flex: 1;
            overflow-y: auto;
        }

        .mode-option {
            display: block;
            padding: 8px;
            margin-bottom: 4px;
            background: #f8f9fa;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-option:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .mode-option.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .mode-option h3 {
            font-size: 0.9em;
            margin-bottom: 2px;
        }

        .mode-option p {
            font-size: 0.75em;
            opacity: 0.8;
            margin: 0;
        }

        /* Center Panel Layout */
        .center-panel {
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 8px;
            min-height: 0;
        }

        /* Time Display - More Compact */
        .time-display-panel {
            padding: 16px;
        }

        .time-display {
            text-align: center;
        }

        .time-value {
            font-size: 2.5em;
            font-weight: 200;
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
            line-height: 1;
        }

        .time-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 4px;
        }

        /* Compact info grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 6px;
            border-radius: 4px;
            text-align: center;
        }

        .info-item .label {
            font-size: 0.65em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            line-height: 1;
        }

        .info-item .value {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-top: 2px;
            line-height: 1;
        }

        /* Timeline - Slimmer */
        .timeline-panel {
            padding: 10px 12px;
        }

        .timeline-viz {
            height: 40px;
            background: #f8f9fa;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            margin-top: 8px;
        }

        .timeline-segment {
            position: absolute;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7em;
            font-weight: 600;
        }

        .timeline-current {
            position: absolute;
            width: 2px;
            height: 100%;
            background: red;
            top: 0;
            z-index: 10;
        }

        /* Configuration Panel */
        .config-panel-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .config-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .tab {
            padding: 4px 12px;
            cursor: pointer;
            border-radius: 4px;
            background: #f8f9fa;
            font-size: 0.8em;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .config-section {
            padding-right: 8px;
        }

        .config-group {
            margin-bottom: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .config-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
            color: #555;
            font-size: 0.85em;
        }

        .config-group input,
        .config-group select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.85em;
        }

        /* Right Panel - Debug */
        .debug-panel {
            display: flex;
            flex-direction: column;
        }

        .debug-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .debug-console {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 8px;
            border-radius: 4px;
            overflow-y: auto;
            min-height: 0;
        }

        .debug-entry {
            margin-bottom: 4px;
            padding: 2px 0;
            border-bottom: 1px solid #333;
            line-height: 1.3;
        }

        .debug-time {
            color: #569cd6;
        }

        .debug-event {
            color: #4ec9b0;
        }

        .debug-data {
            color: #dcdcaa;
        }

        .debug-error {
            color: #f48771;
        }

        /* Buttons - Compact */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-group {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            flex-shrink: 0;
        }

        /* Status Bar - Compact */
        .status-bar {
            background: #2c3e50;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75em;
            margin-top: 8px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #2ecc71;
        }

        .status-indicator.error {
            background: #e74c3c;
        }

        /* Loading animation */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 180px 1fr 250px;
            }

            .time-value {
                font-size: 2.2em;
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 280px;
            }

            .left-panel {
                display: none;
            }

            .info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                height: auto;
                min-height: 100vh;
            }

            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }

            .panel {
                max-height: none;
            }

            .debug-panel {
                order: 3;
            }

            .time-value {
                font-size: 3em;
            }
        }

        /* Utility classes */
        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .text-small { font-size: 0.85em; }
        .text-muted { color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Compact Header -->
        <div class="header">
            <h1>⏰ Time Design Modes Test Interface</h1>
            <div class="status-item">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Initializing...</span>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="main-content">
            <!-- Left Panel: Mode Selection -->
            <div class="panel left-panel">
                <h2>Mode Selection</h2>
                <div class="mode-list" id="modeList">
                    <div class="loading">Loading modes</div>
                </div>
            </div>

            <!-- Center Panel -->
            <div class="center-panel">
                <!-- Time Display -->
                <div class="panel time-display-panel">
                    <div class="time-display">
                        <div class="time-value" id="timeDisplay">--:--:--</div>
                        <div class="time-label" id="periodLabel">Initializing...</div>
                    </div>

                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">Scale</div>
                            <div class="value" id="scaleFactor">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Real Time</div>
                            <div class="value" id="realTime">--:--</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Phase</div>
                            <div class="value" id="currentPhase">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Progress</div>
                            <div class="value" id="progress">-</div>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="panel timeline-panel">
                    <h2>24-Hour Timeline</h2>
                    <div class="timeline-viz" id="timelineViz">
                        <div class="timeline-current" id="timelineMarker"></div>
                    </div>
                </div>

                <!-- Configuration -->
                <div class="panel config-panel">
                    <h2>Configuration</h2>
                    <div class="config-tabs">
                        <div class="tab active" data-tab="settings">Settings</div>
                        <div class="tab" data-tab="advanced">Advanced</div>
                        <div class="tab" data-tab="presets">Presets</div>
                    </div>

                    <div class="config-panel-content">
                        <div class="config-section" id="configContent">
                            <p class="text-muted">Select a mode to configure...</p>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="saveConfigBtn">💾 Save</button>
                        <button class="btn btn-secondary" id="resetConfigBtn">↺ Reset</button>
                        <button class="btn btn-secondary" id="exportConfigBtn">📤 Export</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Debug -->
            <div class="panel debug-panel">
                <h2>Debug Information</h2>

                <div class="debug-stats">
                    <div class="info-item">
                        <div class="label">Mode</div>
                        <div class="value text-small" id="debugModeClass">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Segments</div>
                        <div class="value" id="debugSegmentCount">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Update</div>
                        <div class="value" id="debugUpdateRate">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">FPS</div>
                        <div class="value" id="fpsCounter">-</div>
                    </div>
                </div>

                <h2 class="mt-2">Console</h2>
                <div class="debug-console" id="debugConsole">
                    <div class="debug-entry">
                        <span class="debug-time">00:00:00</span>
                        <span class="debug-event">INIT</span>
                        <span class="debug-data">Starting...</span>
                    </div>
                </div>

                <button class="btn btn-secondary mt-2" onclick="clearDebugConsole()">
                    Clear Console
                </button>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span>Last Update: <span id="lastUpdate">-</span></span>
            </div>
            <div class="status-item">
                <span>Memory: <span id="memoryUsage">-</span></span>
            </div>
            <div class="status-item">
                <span>Version: v1.0.0</span>
            </div>
        </div>
    </div>

    <!-- External Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

    <!-- Test Page Logic -->
    <script type="module">
        // Import TimeDesignManager
        import { timeDesignManager } from './js/time-design/TimeDesignManager.js';

        // Debug console management
        let debugEntries = [];
        const maxDebugEntries = 50; // Reduced for performance

        function addDebugEntry(event, data, type = 'info') {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const entry = { time, event, data, type };
            debugEntries.unshift(entry);

            if (debugEntries.length > maxDebugEntries) {
                debugEntries = debugEntries.slice(0, maxDebugEntries);
            }

            updateDebugConsole();
        }

        function updateDebugConsole() {
            const console = document.getElementById('debugConsole');
            console.innerHTML = debugEntries.map(entry => `
                <div class="debug-entry">
                    <span class="debug-time">${entry.time}</span>
                    <span class="debug-event">${entry.event}</span>
                    <span class="debug-${entry.type}">${entry.data}</span>
                </div>
            `).join('');
        }

        window.clearDebugConsole = function() {
            debugEntries = [];
            updateDebugConsole();
            addDebugEntry('CLEAR', 'Console cleared');
        };

        // Performance monitoring
        let lastFrameTime = performance.now();
        let frameCount = 0;
        let fps = 0;

        function updatePerformanceMetrics() {
            frameCount++;
            const currentTime = performance.now();
            if (currentTime >= lastFrameTime + 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastFrameTime));
                document.getElementById('fpsCounter').textContent = fps;
                frameCount = 0;
                lastFrameTime = currentTime;
            }

            // Memory usage (if available)
            if (performance.memory) {
                const mb = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
                document.getElementById('memoryUsage').textContent = mb + ' MB';
            }
        }

        // Initialize the system
        async function initialize() {
            try {
                addDebugEntry('INIT', 'Starting TimeDesignManager initialization');

                await timeDesignManager.initialize();

                addDebugEntry('INIT', 'TimeDesignManager initialized successfully');

                // Populate mode list
                const modes = timeDesignManager.registry.getAllAsInfo();
                const modeList = document.getElementById('modeList');

                modeList.innerHTML = modes.map(mode => `
                    <div class="mode-option" data-mode-id="${mode.id}">
                        <h3>${mode.name}</h3>
                        <p>${mode.description}</p>
                    </div>
                `).join('');

                // Add click handlers
                modeList.querySelectorAll('.mode-option').forEach(option => {
                    option.addEventListener('click', async (e) => {
                        const modeId = option.dataset.modeId;
                        await selectMode(modeId);
                    });
                });

                // Select current mode
                if (timeDesignManager.currentMode) {
                    document.querySelector(`[data-mode-id="${timeDesignManager.currentMode.id}"]`)?.classList.add('active');
                    await loadModeConfig(timeDesignManager.currentMode.id);
                }

                // Initialize timeline
                initializeTimeline();

                // Start update loop
                updateLoop();

                // Set status
                setStatus('System Ready', false);

            } catch (error) {
                addDebugEntry('ERROR', error.message, 'error');
                setStatus('Initialization Failed', true);
            }
        }

        // Initialize timeline visualization
        function initializeTimeline() {
            const timelineViz = document.getElementById('timelineViz');
            // This will be populated with segments based on current mode
        }

        // Mode selection
        async function selectMode(modeId) {
            try {
                addDebugEntry('MODE_CHANGE', `Switching to ${modeId}`);

                // Update active state
                document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('active'));
                document.querySelector(`[data-mode-id="${modeId}"]`)?.classList.add('active');

                // Load mode
                await timeDesignManager.setMode(modeId);
                await loadModeConfig(modeId);

                addDebugEntry('MODE_CHANGE', `Successfully switched to ${modeId}`);
                updateTimeline();

            } catch (error) {
                addDebugEntry('ERROR', `Failed to switch mode: ${error.message}`, 'error');
                setStatus('Mode Switch Failed', true);
            }
        }

        // Load mode configuration UI
        async function loadModeConfig(modeId) {
            const mode = timeDesignManager.registry.get(modeId);
            const config = timeDesignManager.currentConfig || mode.getDefaultConfig();
            const configContent = document.getElementById('configContent');

            // Generate compact config UI based on mode
            let html = '';

            switch(modeId) {
                case 'classic':
                    html = `
                        <div class="config-group">
                            <label for="designed24Duration">Designed 24 Duration</label>
                            <input type="range" id="designed24Duration" min="0" max="1440" value="${config.designed24Duration}" step="15">
                            <div class="text-small text-muted mt-1">
                                <span id="designed24DurationValue">${Math.floor(config.designed24Duration / 60)}h ${config.designed24Duration % 60}m</span>
                            </div>
                        </div>
                    `;
                    break;

                case 'core-time':
                    html = `
                        <div class="config-group">
                            <label for="morningStart">Morning AH Start</label>
                            <input type="time" id="morningStart" value="${config.morningAH.start}">
                        </div>
                        <div class="config-group">
                            <label for="morningDuration">Morning Duration (min)</label>
                            <input type="number" id="morningDuration" min="0" max="360" value="${config.morningAH.duration}">
                        </div>
                        <div class="config-group">
                            <label for="eveningDuration">Evening Duration (min)</label>
                            <input type="number" id="eveningDuration" min="0" max="360" value="${config.eveningAH.duration}">
                        </div>
                    `;
                    break;

                case 'wake-based':
                    html = `
                        <div class="config-group">
                            <label for="wakeTime">Today's Wake Time</label>
                            <input type="time" id="wakeTime" value="${config.wakeTime}">
                        </div>
                        <div class="config-group">
                            <label for="defaultWakeTime">Default Wake Time</label>
                            <input type="time" id="defaultWakeTime" value="${config.defaultWakeTime}">
                        </div>
                        <div class="config-group">
                            <label for="ahDuration">AH Duration (min)</label>
                            <input type="number" id="ahDuration" min="60" max="300" value="${config.anotherHourDuration}">
                        </div>
                    `;
                    break;

                case 'solar':
                    html = `
                        <div class="config-group">
                            <label for="location">Location</label>
                            <select id="location">
                                <option value="tokyo" ${config.location.city === 'tokyo' ? 'selected' : ''}>Tokyo</option>
                                <option value="newyork" ${config.location.city === 'newyork' ? 'selected' : ''}>New York</option>
                                <option value="london" ${config.location.city === 'london' ? 'selected' : ''}>London</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="dayHours">Day Hours</label>
                            <input type="range" id="dayHours" min="1" max="23" value="${config.dayHours}" step="1">
                            <div class="text-small text-muted mt-1">
                                <span id="dayHoursValue">${config.dayHours} hours</span>
                            </div>
                        </div>
                    `;
                    break;
            }

            configContent.innerHTML = html;

            // Add event listeners for real-time updates
            configContent.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', () => {
                    updateConfigPreview();

                    // Update range display values
                    if (input.type === 'range') {
                        const displayId = input.id + 'Value';
                        const display = document.getElementById(displayId);
                        if (display) {
                            if (input.id === 'designed24Duration') {
                                const minutes = parseInt(input.value);
                                display.textContent = `${Math.floor(minutes / 60)}h ${minutes % 60}m`;
                            } else if (input.id === 'dayHours') {
                                display.textContent = input.value + ' hours';
                            }
                        }
                    }
                });
            });

            // Update debug info
            document.getElementById('debugModeClass').textContent = mode.constructor.name;
        }

        // Update configuration preview
        function updateConfigPreview() {
            addDebugEntry('CONFIG', 'Configuration changed (preview)');
            // This would update the timeline visualization in real-time
        }

        // Update timeline visualization
        function updateTimeline() {
            // This will draw the timeline segments based on current mode
            const timelineViz = document.getElementById('timelineViz');
            // Implementation depends on mode-specific segments
        }

        // Save configuration
        document.getElementById('saveConfigBtn').addEventListener('click', async () => {
            try {
                const modeId = timeDesignManager.currentMode.id;
                const config = collectConfigFromUI(modeId);

                await timeDesignManager.setMode(modeId, config);
                addDebugEntry('SAVE', `Configuration saved for ${modeId}`);
                setStatus('Configuration Saved', false);

            } catch (error) {
                addDebugEntry('ERROR', `Save failed: ${error.message}`, 'error');
                setStatus('Save Failed', true);
            }
        });

        // Reset configuration
        document.getElementById('resetConfigBtn').addEventListener('click', async () => {
            const modeId = timeDesignManager.currentMode.id;
            const mode = timeDesignManager.registry.get(modeId);
            const defaultConfig = mode.getDefaultConfig();

            await timeDesignManager.setMode(modeId, defaultConfig);
            await loadModeConfig(modeId);

            addDebugEntry('RESET', `Configuration reset for ${modeId}`);
            setStatus('Configuration Reset', false);
        });

        // Export configuration
        document.getElementById('exportConfigBtn').addEventListener('click', () => {
            const config = {
                mode: timeDesignManager.currentMode.id,
                config: timeDesignManager.currentConfig,
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `time-design-config-${config.mode}-${Date.now()}.json`;
            a.click();

            addDebugEntry('EXPORT', 'Configuration exported');
        });

        // Collect configuration from UI
        function collectConfigFromUI(modeId) {
            const config = {};

            switch(modeId) {
                case 'classic':
                    config.designed24Duration = parseInt(document.getElementById('designed24Duration').value);
                    break;

                case 'core-time':
                    config.morningAH = {
                        start: document.getElementById('morningStart').value,
                        duration: parseInt(document.getElementById('morningDuration').value)
                    };
                    config.eveningAH = {
                        duration: parseInt(document.getElementById('eveningDuration').value)
                    };
                    break;

                case 'wake-based':
                    config.wakeTime = document.getElementById('wakeTime').value;
                    config.defaultWakeTime = document.getElementById('defaultWakeTime').value;
                    config.anotherHourDuration = parseInt(document.getElementById('ahDuration').value);
                    break;

                case 'solar':
                    const locationSelect = document.getElementById('location');
                    config.location = {
                        city: locationSelect.value
                    };
                    config.dayHours = parseInt(document.getElementById('dayHours').value);
                    break;
            }

            return config;
        }

        // Update loop
        function updateLoop() {
            try {
                const now = moment();
                const calculation = timeDesignManager.calculate(now.toDate(), moment.tz.guess());

                // Update time display
                document.getElementById('timeDisplay').textContent = 
                    `${String(calculation.hours).padStart(2, '0')}:${String(calculation.minutes).padStart(2, '0')}:${String(calculation.seconds).padStart(2, '0')}`;

                // Update period label
                document.getElementById('periodLabel').textContent = calculation.segmentInfo?.label || 'Another Hour';

                // Update info
                document.getElementById('scaleFactor').textContent = calculation.scaleFactor.toFixed(2) + 'x';
                document.getElementById('realTime').textContent = now.format('HH:mm:ss');
                document.getElementById('currentPhase').textContent = calculation.segmentInfo?.type || '-';

                // Update progress
                if (calculation.segmentInfo) {
                    const elapsed = now.valueOf() - calculation.segmentInfo.startTime;
                    const total = calculation.segmentInfo.endTime - calculation.segmentInfo.startTime;
                    const progress = Math.round((elapsed / total) * 100);
                    document.getElementById('progress').textContent = progress + '%';
                }

                // Update timeline marker
                const marker = document.getElementById('timelineMarker');
                const dayProgress = (calculation.hours * 60 + calculation.minutes) / 1440;
                marker.style.left = (dayProgress * 100) + '%';

                // Update debug info
                document.getElementById('debugSegmentCount').textContent = calculation.segments?.length || '-';
                document.getElementById('debugUpdateRate').textContent = '60 Hz';

                // Update last update time
                document.getElementById('lastUpdate').textContent = now.format('HH:mm:ss.SSS');

                // Update performance metrics
                updatePerformanceMetrics();

            } catch (error) {
                console.error('Update loop error:', error);
            }

            // Next frame
            requestAnimationFrame(updateLoop);
        }

        // Status management
        function setStatus(text, isError = false) {
            document.getElementById('statusText').textContent = text;
            const indicator = document.getElementById('statusIndicator');
            indicator.classList.toggle('error', isError);
        }

        // Tab switching
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    // Tab content switching would go here
                });
            });
        });

        // Initialize on load
        initialize();
    </script>
</body>
</html>